# Полное руководство

## Соглашения принятые в документации

`< имя_параметра >` - в угловых скобках обозначаются обязательные аргументы

`[ имя_параметра ]` - в квадратынх скобках обозначаются не обязательные аргументы

***имя_параметра*** - жирным курсивом выделются имена параметров

`!!!` - подобным образом обозначается важная особенность работы, на которую стоит обратить внимание

## Запуск

Для запуска сервера необходимо выполнить следующую команду:

`docker run -p <port>:80  -v <rules_path>:/app/rules  mnkvsoft/simplemockserver`

либо добавить следующие строки в docker-compose

```
simplemockserver:
    container_name: simplemockserver
    image: mnkvsoft/simplemockserver
    ports:
      - "<port>:80"
    volumes:
       - <rules_path>:/app/rules
```

***port*** - номер порта, который будет слушать сервер

***rules_path*** - каталог в котором будут содержать правила и другие файлы (далее **рабочий каталог**), обрабатываемые сервером

## Обработка рабочего каталога

При своей работе **SMS** постоянно отслеживает рабочий каталог на предмет изменений и если они появились, то выполняет загрузку актуальных правил.

Файлы правил должны иметь расширение `.rules`. SMS выполняет их загрузку вне зависимости от их расположения в рабочем каталого (т.е. вложенность каталогов не имеет значения).

Проверить текущее состояние сервера можно командой:

`GET http://localhost/sys/state`

## Функциональные возможности сервера
- настройка правил сопосталения запросов
- настройка выдаваемых ответов
- настройка дополнительных действий, производимых при успешном сопоставлении запросов (вызов сторонних сервисов)

## Правила сопоставления запросов

SMS позволяет настроить правила по следующим параметрам запроса:
- метод (`GET`, `PUT`, `POST`, `DELETE`, `HEAD`, `TRACE`, `OPTIONS`, `CONNECT`)
- путь 
- параметры строки запроса
- заголовки
- тело

Пример:

```http request
-------------------- rule

POST /pay/card?amount=100

headers:
Token: qwerty

body:
pan=1111222233334444

----- response

code:
200

body:
static rules matched!
```

Приведенное выше правило будет срабатывать при выполнении всех следующих условий:
- запрос выполен методом `POST`
- запрос выполнен по пути `/pay/card`
- в параметрах строки запроса присутствует параметр `amount` со значением `100`. 
- наличие заголовка `Token` со значением `qwerty`
- в теле запроса содержится контент `pan=1111222233334444`

Выше был приведен пример правила, где все параметры запроса заданы статично, далее будет описано динамическое сопоставление параметров запроса.
 

## Динамическое сопоставление параметров запроса

### Сопоставление пути

Сопоставление любого сегмента пути может быть настроено следующим образом:
`[префикс]{{ <функция_сопосталения> }}[суффикс]`


***префикс*** - значение, с которого начинается сегмент

***суффикс*** - значение, на которое заканчивается сегмент

***функция сопосталения*** - одна из [функций сопоставления](docs/match_functions.md)

#### Примеры

- C указанием начального и конечного значения в сегменте
```http request
-------------------- rule

GET /user/ivanov_{{ any }}_petrovich

----- response

code:
200

body:
ivanov user matched!
```
под данное правило попадут следующие запросы
```
GET /user/ivanov_petr_petrovich
GET /user/ivanov_ivan_petrovich
```

---
- C ипользованием только функции сопоставления

```http request
-------------------- rule

GET /user/{{ any }}

----- response

code:
200

body:
any user matched!
```
под данное правило попадут следующие запросы
```
GET /user/123
GET /user/ivan_petrovich
GET /user/df1243
GET /user/petr
```

---
- C ипользованием функций в разных сегментах

```http request
-------------------- rule

GET /user/{{ any }}/{{ int }}

----- response

code:
200

body:
any user with id matched!
```
под данное правило попадут следующие запросы
```
GET /user/123/1
GET /user/ivan_petrovich/3
```

### Сопоставление параметров строки строки

Сопоставление любого параметра строки запроса может быть настроено следующим образом:
`[префикс]{{ <функция_сопосталения> }}[суффикс]`


***префикс*** - префикс, с которого начинается значение

***суффикс*** - суффикс, с которого начинается значение

***функция сопосталения*** - одна из [функций сопоставления](docs/match_functions.md)

---

#### Примеры

- c указанием начального и конечного значения в параметре строки запроса
```http request
-------------------- rule

GET /user?name=a{{ any }}a

----- response

code:
200

body:
user a***a matched!
```
под данное правило попадут следующие запросы
```
GET /user?name=anna
GET /user?name=alina
```

---

- C ипользованием только функции сопоставления

```http request
-------------------- rule

GET /user?name={{ any }}

----- response

code:
200

body:
any user by query param matched!
```
под данное правило попадут следующие запросы
```
GET /user?name=nikolas
GET /user?name=silvester
```
---
- C ипользованием функций в разных параметрах

```http request
-------------------- rule

GET /user?name={{ any }}&ago={{ int }}

----- response

code:
200

body:
any user with ago matched!
```
под данное правило попадут следующие запросы
```
GET /user?name=pavel&ago=36
GET /user?name=denis&ago=35&height=180
```

#### :triangular_flag_on_post: Особенность работы

Сопоставление по параметру строки запроса указывает шаблон только для этого параметра и не исключает присутствия других параметров в запросе

#### Пример

```http request
-------------------- rule

GET /user?name={{ any }}

----- response

code:
200

body:
user matched!
```

под указанное правило попадут оба запроса

```http request
GET /user?name=nikolas
GET /user?name=nikolas&age=30
```
